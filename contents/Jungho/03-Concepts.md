# Concepts

> 여러 우수한 기업들이 카프카를 서둘러 도입하고 많은 개발자가 좋아하는 이유는 __높은 처리량, 빠른 응답속도, 안정성__ 때문이다.

## 분산 시스템

- 분산 시스템의 장점은 __높은 성능과 장애 대응에 유연하다는 것__ 이다.
- 분산 시스템은 부하가 높은 경우 시스템 확장이 용이하다.

카프카도 분산 시스템이므로 최초 구성한 클러스터의 리소스가 한계치에 도달해 더욱 높은 메시지 처리량이 필요한 경우, 브로커를 추가하는 방식으로 확장이 가능하다. 브로커는 매우 간단하게 추가할 수 있다.

## 페이지 캐시

카프카는 높은 처리량을 얻기 위해 몇 가지 기능을 추가했는데 그중 대표적인 것이 페이지 캐시(page cache)의 이용이다. 즉, 카프카도 OS 의 페이지 캐시를 활용하는 방식으로 설계되어 있다.

페이지 캐시는 직접 디스크에 읽고 쓰는 대신 물리 메모리 중 애플리케이션이 사용하지 않는 일부 잔여 메모리를 활용한다. 이렇게 페이지 캐시를 이용하면 디스크 I/O 에 대한 접근이 줄어들기 때문에 성능을 높일 수 있다.

즉, 카프카가 직접 디스크에 읽고 쓰기를 하지 않고 페이지 캐시를 통해 일고 쓰기를 한다고 이해하면 된다.

```
Kafka - Page Cache - Disk
```

## 배치 전송 처리

수많은 통신을 묶어서 처리할 수 있다면 단건으로 통신할 때에 비해 네트워크 오버헤드를 줄일 수 있으며, 장기적으로는 더욱 빠르고 효율적으로 처리할 수 있다.

> 예를 들어, 온라인 상품 구매 프로세스에서 상품의 재고 수량 업데이트 작업은 지연 없이 실시간으로 처리 되어야 하지만, 구매 로그를 저장소로 보내는 작업은 이미 로그가 서버에 기록 되어있으므로 실시간 처리 보다는 배치 처리가 좋다.

카프카에서는 이러한 장점을 지닌 배치 전송을 권장한다.

## 압축 전송

카프카는 메시지 전송 시 좀 더 성능이 높은 압축 전송을 사용하는 것을 권장한다.

- 카프카에서 지원하는 압축 타입
  - gzip, snappy, lz4, zstd 등
  - 높은 압축률이 필요한 경우: gzip or zstd
  - 빠른 응답 속도가 필요한 경우: lz4 or snappy

압축 만으로도 네트워크 대역 폭이나 회선 비용 등을 줄일 수 있다. 이에 더해 배치 전송과 결합해서 사용한다면 더욱 높은 효과를 얻게 된다.

## 토픽, 파티션, 오프셋

카프카는 토픽(topic) 이라는 곳에 데이터를 저장하는데 이는 메일 전송 시스템에서 이메일 주소 정도로 생각하면 된다.

- 토픽은 병렬 처리를 위해 여러개의 파티션이라는 단위로 다시 나뉜다.
- 카프카에서는 이와 같은 파티셔닝을 통해 단 하나의 토픽이라도 높은 처리량을 수행할 수 있다.
- 이 파티션의 메시지가 저장되는 위치를 오프셋(offset) 이라고 한다.
  - 오프셋은 순차적으로 증가하는 숫자(64bit 정수)로 되어 있다.
  - [Partiton and Offset](https://sookocheff.com/post/kafka/kafka-in-a-nutshell/)

__카프카에서는 오프셋을 통해 메시지 순서를 보장하고 컨슈머에서는 마지막까지 읽은 위치를 알 수 있다.__

## 고가용성

카프카에서는 리플리케이션을 통해서 고가용성을 보장한다. 리플리케이션 기능은 토픽 자체를 복제하는 것이 아니라, 토픽의 파티션을 복제한다.

원본과 리플리케이션을 구분하기 위해 흔히 마스터, 미러 같은 용어를 사용하는데 카프카에서는 리더(leader)와 팔로워(follower)라고 부른다.

| 리플리케이션 팩터 수 | 리더 수 | 팔로워 수 |
|-----------------|-------|---------|
| 2               |   1   |    1    |
| 3               |   1   |    2    |
| 4               |   1   |    3    |

팔로워 수가 많으면 브로커의 디스크 공간도 소비되므로 이상적인 리플리케이션 팩터 수를 유지해야 한다.

## 주키퍼의 의존성

주키퍼는 여러 대의 서버를 앙상블(클러스터)로 구성하고, 살아 있는 노드 수가 과반수 이상 유지된다면 지속적인 서비스가 가능한 구조이다. 따라서 주키퍼는 반드시 `홀수`로 구성되어야 한다.

- 지노드(znode)를 통해 카프카의 메타 정보가 주키퍼에 기록된다.
- 주키퍼는 이러한 지노드를 이용해 브로커의 노드 관리, 토픽 관리, 컨트롤러 관리 등 매우 중요한 역할을 하고 있다.
- 하지만 주키퍼를 사용하게되면 관리 계층을 추가할 때의 문제점 때문에 카프카에서 주키퍼에 대한 의존성을 제거하려고 한다.
  - https://www.ciokorea.com/t/21999/%EA%B0%9C%EB%B0%9C%EC%9E%90/235594
  - 주키퍼를 대체할 녀석은 KRaft 이다.
  - [Mark KRaft as Production Ready](https://cwiki.apache.org/confluence/display/KAFKA/KIP-833%3A+Mark+KRaft+as+Production+Ready) 

## Links

- [what-is-kraft-and-how-do-you-use-it](https://www.confluent.io/blog/what-is-kraft-and-how-do-you-use-it/)
